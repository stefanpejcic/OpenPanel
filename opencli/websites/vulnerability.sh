#!/bin/bash
################################################################################
# Script Name: websites/vulnerability.sh
# Description: Scan WP site for vulnerabilities.
# Usage: opencli websites-vulnerability <DOMAIN> [--all]
# Author: Stefan Pejcic
# Created: 27.06.2024
# Last Modified: 18.02.2026
# Company: openpanel.com
################################################################################

# ======================================================================
# Validation
if ! command -v jq &> /dev/null; then
  echo "jq could not be found, please install jq to proceed."
  exit 1
fi

usage() {
  echo "Usage: opencli websites-vulnerability <website> OR opencli websites-vulnerability --all"
  exit 1
}

if [ $# -eq 0 ]; then
  usage
fi

# ======================================================================
# Constants
readonly API_ENDPOINT="https://api.openpanel.com/vulnerability"
readonly RESULTS_DIR="/etc/openpanel/wordpress/vulnerability/"
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
RESET='\033[0m'

# ======================================================================
# Cache
declare -A API_CACHE  # key = "type_name", value = JSON response

# ======================================================================
# Counters
TOTAL_SITES=0
TOTAL_PLUGINS=0
TOTAL_MU_PLUGINS=0
TOTAL_THEMES=0
SCRIPT_START_TIME=0
SCRIPT_END_TIME=0

# ======================================================================
# Helpers
mkdir -p $RESULTS_DIR

# Function to compare semantic versions
version_lte() {
    # returns 0 if $1 <= $2, 1 if $1 > $2
    [ "$1" = "$2" ] && return 0
    local sorted
    sorted=$(printf "%s\n%s\n" "$1" "$2" | sort -V | head -n1)
    [[ "$sorted" == "$1" ]]
}

scan_dir() {
    local TYPE=$1   # "theme" or "plugin"
    local DIR=$2
    declare -n RESULT_REF=$3

    if [ -d "$DIR" ]; then
        echo "   ${TYPE^^}S:"

        shopt -s nullglob
        items=("$DIR"/*)
        shopt -u nullglob
        total=${#items[@]}

        if [ "$TYPE" == "plugin" ]; then
            TOTAL_PLUGINS=$((TOTAL_PLUGINS + total))
        elif [ "$TYPE" == "mu-plugin" ]; then
            TOTAL_MU_PLUGINS=$((TOTAL_MU_PLUGINS + total))
        elif [ "$TYPE" == "theme" ]; then
            TOTAL_THEMES=$((TOTAL_THEMES + total))
        fi

        if [ "$total" -eq 0 ]; then
            echo -e "      - ${YELLOW}[!]${RESET} No ${TYPE}s found"
            return
        fi

        count=0
        for item in "${items[@]}"; do
            name=""
            version=""
            fetch_api=true
            file_name=""

            if [ -d "$item" ]; then
                name=$(basename "$item")
                if [ "$TYPE" == "theme" ] && [ -f "$item/style.css" ]; then
                    file_name=$(grep -i "Theme Name:" "$item/style.css" | head -n1 | awk -F: '{print $2}' | xargs)
                    version=$(grep -i "Version:" "$item/style.css" | head -n1 | awk -F: '{print $2}' | xargs)
                elif [ "$TYPE" == "plugin" ] || [ "$TYPE" == "mu-plugin" ]; then
                    main_php=$(grep -rl "Plugin Name:" "$item" | head -n1)
                    if [ -n "$main_php" ]; then
                        file_name=$(grep -i "Plugin Name:" "$main_php" | head -n1 | awk -F: '{print $2}' | xargs)
                        version=$(grep -i "Version:" "$main_php" | head -n1 | awk -F: '{print $2}' | xargs)
                        name=$(basename "$item")
                    else
                        fetch_api=false
                    fi
                fi
            elif [[ "$TYPE" != "theme" && "$item" == *.php && $(basename "$item") != "index.php" ]]; then
                name=$(basename "$item" .php)
                file_name=$(grep -i "Plugin Name:" "$item" | head -n1 | awk -F: '{print $2}' | xargs)
                version=$(grep -i "Version:" "$item" | head -n1 | awk -F: '{print $2}' | xargs)
            else
                fetch_api=false
            fi

            if [ -n "$name" ]; then
                ((count++))
                prefix="├──"
                [ "$count" -eq "$total" ] && prefix="└──"
                display_name="$name"
                [ -n "$version" ] && display_name="$file_name v$version"
                echo "      $prefix $display_name ($count/$total)"

                if $fetch_api; then
                    CACHE_KEY="${TYPE}_$name"
                    if [[ -n "${API_CACHE[$CACHE_KEY]}" ]]; then
                        response="${API_CACHE[$CACHE_KEY]}"
                    else
                        URI="$API_ENDPOINT/$TYPE/$name"
                        response=$(curl -s --connect-timeout 5 --max-time 15 "$URI")
                        if echo "$response" | jq . >/dev/null 2>&1; then
                            API_CACHE["$CACHE_KEY"]="$response"
                        else
                            echo -e "         ${YELLOW}[!]${RESET} Failed to fetch data from $URI"
                            response="null"
                        fi
                    fi

                    # Filter vulnerabilities based on installed version
                  if [ "$TYPE" == "plugin" ] && [ "$version" != "" ] && [ "$response" != "null" ]; then
                      # Check if .data.vulnerability exists and is an array
                      has_vuln=$(echo "$response" | jq '.data.vulnerability? // empty | type=="array"')
                      if [[ "$has_vuln" == "true" ]]; then
                          filtered=$(echo "$response" | jq --arg ver "$version" '
                              .data.vulnerability |= map(select(
                                  if .operator.max_version != null then
                                      ($ver | split(".") | map(tonumber? // 0)) <= (.operator.max_version | split(".") | map(tonumber? // 0))
                                  else
                                      true
                                  end
                              ))
                          ')
                          RESULT_REF["$CACHE_KEY"]="$filtered"
                          API_CACHE["$CACHE_KEY"]="$filtered"
                      else
                          # If vulnerability field is null, keep response as-is
                          RESULT_REF["$CACHE_KEY"]="$response"
                          API_CACHE["$CACHE_KEY"]="$response"
                      fi
                  else
                      RESULT_REF["$CACHE_KEY"]="$response"
                  fi
                fi
            fi
        done
    else
        echo -e "   - ${YELLOW}[!]${RESET} No ${TYPE}s directory found"
    fi
}

# ======================================================================
generate_report() {
    local website=$1
    local number=$2
    local total_sites=$3

    local optional_msg=""
    [[ -n "$number" && -n "$total_sites" ]] && optional_msg=" [$number of $total_sites]"
    echo "[*] $website$optional_msg"

    domain="${website%%/*}"
    url_path="${website#${domain}}"

    OUTPUT=$(opencli domains-whoowns "$domain" --context --docroot)
    read USERNAME CONTEXT DOCROOT <<<$(echo "$OUTPUT")
    DOCROOT_PATH=${DOCROOT#/var/www/html/}
    FINAL_PATH="/home/${CONTEXT}/docker-data/volumes/${CONTEXT}_html_data/_data/${DOCROOT_PATH}/${url_path}"

    if [ ! -d "$FINAL_PATH" ]; then
        echo -e "   - ${YELLOW}ERROR${RESET}: Docroot directory does not exist: $FINAL_PATH"
        return 1
    fi

    declare -A result

    # 1. core
    VERSION_FILE="$FINAL_PATH/wp-includes/version.php"
    if [ -f "$VERSION_FILE" ]; then
        WP_VERSION=$(grep "\$wp_version =" "$VERSION_FILE" | cut -d "'" -f2)
        if [[ "$WP_VERSION" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
            echo "   Core:"
            echo "      └── WordPress $WP_VERSION"

            echo "UPDATE sites SET version = '$WP_VERSION' WHERE site_name = '$website' AND type = 'wordpress';" | mysql -s -N > /dev/null 2>&1

            CORE_CACHE_KEY="core_version_$WP_VERSION"
            if [[ -n "${API_CACHE[$CORE_CACHE_KEY]}" ]]; then
                result["$CORE_CACHE_KEY"]="${API_CACHE[$CORE_CACHE_KEY]}"
            else
                CORE_URI="$API_ENDPOINT/core/$WP_VERSION"
                response=$(curl -s --connect-timeout 5 --max-time 15 "$CORE_URI")
                if echo "$response" | jq . >/dev/null 2>&1; then
                    result["$CORE_CACHE_KEY"]="$response"
                    API_CACHE["$CORE_CACHE_KEY"]="$response"
                else
                    echo -e "   - ${YELLOW}[!]${RESET} Failed to fetch data from $CORE_URI"
                fi
            fi           
        else
            echo -e "   - ${YELLOW}[!]${RESET} Skipping core: failed to fetch \$wp_version."
        fi
    else
        echo -e "   - ${YELLOW}[!]${RESET} No wp-includes/version.php file found"        
    fi

    # 2. themes
    THEME_DIR="$FINAL_PATH/wp-content/themes"
    scan_dir "theme" "$THEME_DIR" result

    # 3. plugins
    PLUGIN_DIR="$FINAL_PATH/wp-content/plugins"
    scan_dir "plugin" "$PLUGIN_DIR" result

    # 4. mu-plugins
    MU_PLUGIN_DIR="$FINAL_PATH/wp-content/mu-plugins"
    scan_dir "mu-plugin" "$MU_PLUGIN_DIR" result

    # 5. save JSON

    if [ ${#result[@]} -gt 0 ]; then
      timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      json="{"
      json+="\"timestamp\":\"$timestamp\""
      first=true
      for key in "${!result[@]}"; do
          json+=",\"$key\":${result[$key]}"
      done
      json+="}"

      filename="$RESULTS_DIR$(echo "$website" | sed 's|https\?://||' | sed 's|/|_|g').json"
      echo "$json" > "$filename"
      echo -e "   ${GREEN}[+]${RESET} Vulnerability API data saved" # to $filename"       
    else
        echo -e "   ${RED}[-]${RESET} No valid API data retrieved; skipping save."
    fi
}

# ======================================================================
# Main
source /usr/local/opencli/db.sh

if [[ "$1" == "-all" || "$1" == "--all" ]]; then
    websites=$(opencli websites-all wordpress)
    if [[ -z "$websites" || "$websites" == "No sites found for type 'wordpress'." ]]; then
        echo -e "${RED}[!]${RESET} No WordPress sites found in the database or opencli command error."
        exit 1
    fi

    readarray -t website_array <<<"$websites"
    site_total=${#website_array[@]}

    TOTAL_SITES=$site_total
    SCRIPT_START_TIME=$(date +%s)

    echo "Starting report generation for $site_total WordPress site(s)"
    site_count=0
    for website in "${website_array[@]}"; do
        site_count=$((site_count + 1))
        generate_report "$website" "$site_count" "$site_total"
        echo "-------------------------------------------------"
    done

    SCRIPT_END_TIME=$(date +%s)
    TOTAL_DURATION=$((SCRIPT_END_TIME - SCRIPT_START_TIME))

    echo ""
    echo "==================== SUMMARY ===================="
    echo "Sites Scanned          : $TOTAL_SITES"
    echo "WP Plugins             : $TOTAL_PLUGINS"
    [ -n "$TOTAL_MU_PLUGINS" ] && [ "$TOTAL_MU_PLUGINS" -ne 0 ] && echo "WP Must-Use Plugins    : $TOTAL_MU_PLUGINS"
    echo "WP Themes              : $TOTAL_THEMES"
    echo "Total Duration         : ${TOTAL_DURATION}s"
  
    HOURS=$((TOTAL_DURATION / 3600))
    MINUTES=$(((TOTAL_DURATION % 3600) / 60))
    SECONDS=$((TOTAL_DURATION % 60))
 
    printf "Total Time (pretty) : %02d:%02d:%02d\n" $HOURS $MINUTES $SECONDS
    echo "================================================="

elif [ $# -eq 1 ]; then
    generate_report "$1"
else
    usage
fi
