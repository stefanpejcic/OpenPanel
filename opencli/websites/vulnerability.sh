#!/bin/bash
################################################################################
# Script Name: websites/vulnerability.sh
# Description: Scan WP site for vulnerabilities.
# Usage: opencli websites-vulnerability <DOMAIN> [--all]
# Author: Stefan Pejcic
# Created: 27.06.2024
# Last Modified: 19.02.2026
# Company: openpanel.com
# Copyright (c) openpanel.com
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
################################################################################

# ======================================================================
# Validation
if ! command -v jq &> /dev/null; then
  echo "jq could not be found, please install jq to proceed."
  exit 1
fi

usage() {
  echo "Usage: opencli websites-vulnerability <website> OR opencli websites-vulnerability --all"
  exit 1
}

[ $# -eq 0 ] && usage

# ======================================================================
# Constants & Setup
readonly API_ENDPOINT="https://api.openpanel.com/vulnerability"
readonly RESULTS_DIR="/etc/openpanel/wordpress/vulnerability/"
readonly TMP_DIR="/tmp/openpanel_vuln_$(date +%s)"

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
RESET='\033[0m'

mkdir -p "$RESULTS_DIR"
mkdir -p "$TMP_DIR"

MAX_PARALLEL=10

# Cleanup temp files on exit
trap "rm -rf $TMP_DIR" EXIT

# ======================================================================
# Counters (Global)
TOTAL_SITES=0
TOTAL_PLUGINS=0
TOTAL_MU_PLUGINS=0
TOTAL_THEMES=0

# ======================================================================
# Background API Worker
# ======================================================================
# This function runs in a subshell to handle the API request and filtering
fetch_api_data() {
    local type=$1
    local name=$2
    local version=$3
    local cache_file="$TMP_DIR/${type}_${name}.json"

    # If already fetched by another site in the same run, skip
    if [ -f "$cache_file" ]; then return; fi

    local uri="$API_ENDPOINT/$type/$name"
    local response
    response=$(curl -s --connect-timeout 5 --max-time 15 "$uri")

    # Validate JSON
    if ! echo "$response" | jq . >/dev/null 2>&1; then
        echo "null" > "$cache_file"
        return
    fi

    # Filter by version if applicable
    if [ -n "$version" ] && [ "$response" != "null" ]; then
        filtered=$(echo "$response" | jq -c --arg ver "$version" '
            def v_to_a: split(".") | map(tonumber? // 0);
            .data.vulnerability |= (
                if (type == "array" or (. != null)) then
                    [ .[]? | select(
                        .operator.max_version == null or 
                        ($ver | v_to_a) <= (.operator.max_version | v_to_a)
                    ) ]
                else [] end
            )
        ' 2>/dev/null)

        vuln_count=$(echo "$filtered" | jq '.data.vulnerability | length // 0')
        if [[ "$vuln_count" =~ ^[0-9]+$ ]] && [ "$vuln_count" -gt 0 ]; then
            echo "$filtered" > "$cache_file"
        else
            echo "null" > "$cache_file"
        fi
    else
        echo "null" > "$cache_file"
    fi
}

# ======================================================================
# Helpers
# ======================================================================
scan_dir() {
    local TYPE=$1
    local DIR=$2
    declare -n RESULT_REF=$3

    if [ -d "$DIR" ]; then
        echo "    ${TYPE^^}S:"
        shopt -s nullglob
        local raw_items=("$DIR"/*)
        shopt -u nullglob

        # Filter items: Exclude index.php and non-relevant files
        local items=()
        for item in "${raw_items[@]}"; do
            local base=$(basename "$item")
            # Skip index.php and hidden files
            [[ "$base" == "index.php" || "$base" == .* ]] && continue
            
            if [ -d "$item" ]; then
                items+=("$item")
            elif [[ "$TYPE" != "theme" && "$item" == *.php ]]; then
                items+=("$item")
            fi
        done

        local total=${#items[@]}

        case "$TYPE" in
            "plugin") TOTAL_PLUGINS=$((TOTAL_PLUGINS + total)) ;;
            "mu-plugin") TOTAL_MU_PLUGINS=$((TOTAL_MU_PLUGINS + total)) ;;
            "theme") TOTAL_THEMES=$((TOTAL_THEMES + total)) ;;
        esac

        if [ "$total" -eq 0 ]; then
            echo -e "      - ${YELLOW}[!]${RESET} No ${TYPE}s found"
            return
        fi

        # First Pass: Identify and launch parallel requests
        local current_jobs=0
        for item in "${items[@]}"; do
            local name="" version="" fetch_api=true
            
            if [ -d "$item" ]; then
                name=$(basename "$item")
                if [ "$TYPE" == "theme" ] && [ -f "$item/style.css" ]; then
                    version=$(grep -i "Version:" "$item/style.css" | head -n1 | awk -F: '{print $2}' | xargs | tr -d '\r')
                elif [ "$TYPE" == "plugin" ] || [ "$TYPE" == "mu-plugin" ]; then
                    main_php=$(grep -rl "Plugin Name:" "$item" | head -n1)
                    [ -n "$main_php" ] && version=$(grep -i "Version:" "$main_php" | head -n1 | awk -F: '{print $2}' | xargs | tr -d '\r') || fetch_api=false
                fi
            else
                # Single file plugin
                name=$(basename "$item" .php)
                version=$(grep -i "Version:" "$item" | head -n1 | awk -F: '{print $2}' | xargs | tr -d '\r')
            fi

            if [ -n "$name" ] && $fetch_api; then
              while (( $(jobs -rp | wc -l) >= MAX_PARALLEL )); do
                  wait -n    # Wait for the next background job to finish
              done
              fetch_api_data "$TYPE" "$name" "$version" &
            fi
        done
        wait 

        # Second Pass: Collect results and print UI
        local count=0
        for item in "${items[@]}"; do
            ((count++))
            # Reset version variable so it doesn't leak from previous item
            local version=""
            local name=$(basename "$item" .php)
            
            if [ -d "$item" ]; then
                if [ "$TYPE" == "theme" ] && [ -f "$item/style.css" ]; then
                    version=$(sed -n 's/^[[:space:]]*Version:[[:space:]]*//p' "$item/style.css" | tr -d '\r' | xargs)
                else
                    main_php=$(grep -rl "Plugin Name:" "$item" | head -n1)
                    [ -n "$main_php" ] && version=$(sed -n 's/^[[:space:]]*Version:[[:space:]]*//p' "$main_php" | tr -d '\r' | xargs)
                fi
            else
                version=$(sed -n 's/^[[:space:]]*Version:[[:space:]]*//p' "$item" | tr -d '\r' | xargs)
            fi

            local cache_file="$TMP_DIR/${TYPE}_${name}.json"
            prefix="├──"
            [ "$count" -eq "$total" ] && prefix="└──"
            
            echo -e "      $prefix $name ${version:+ $version} ($count/$total)"

            if [ -f "$cache_file" ]; then
                res=$(cat "$cache_file")
                if [ "$res" != "null" ]; then
                    RESULT_REF["${TYPE}_${name}"]="$res"
                fi
            fi
        done
    fi
}

generate_report() {
    local website=$1
    local number=$2
    local total_sites=$3

    echo "[*] $website ${number:+[$number of $total_sites]}"

    domain="${website%%/*}"
    url_path="${website#${domain}}"

    OUTPUT=$(opencli domains-whoowns "$domain" --context --docroot)
    read USERNAME CONTEXT DOCROOT <<<$(echo "$OUTPUT")
    DOCROOT_PATH=${DOCROOT#/var/www/html/}
    FINAL_PATH="/home/${CONTEXT}/docker-data/volumes/${CONTEXT}_html_data/_data/${DOCROOT_PATH}/${url_path}"

    if [ ! -d "$FINAL_PATH" ]; then
        echo -e "   - ${YELLOW}ERROR${RESET}: Docroot directory does not exist: $FINAL_PATH"
        return 1
    fi

    declare -A result

    # 1. Core
    VERSION_FILE="$FINAL_PATH/wp-includes/version.php"
    if [ -f "$VERSION_FILE" ]; then
        local WP_VERSION=$(sed -n "s/\$wp_version = '\([^']*\)';/\1/p" "$VERSION_FILE")
        if [[ "$WP_VERSION" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
            echo "   Core:"
            echo "      └── WordPress $WP_VERSION"
            echo "UPDATE sites SET version = '$WP_VERSION' WHERE site_name = '$website' AND type = 'wordpress';" | mysql -s -N > /dev/null 2>&1
            
            CORE_URI="$API_ENDPOINT/core/$WP_VERSION"
            response=$(curl -s --connect-timeout 1 --max-time 2 "$CORE_URI")
            if echo "$response" | jq -e '.data.vulnerability | length > 0' >/dev/null 2>&1; then
                result["core_$WP_VERSION"]="$response"
            fi
        fi
    fi

    # 2. Parallel Scans
    scan_dir "theme" "$FINAL_PATH/wp-content/themes" result
    scan_dir "plugin" "$FINAL_PATH/wp-content/plugins" result
    scan_dir "mu-plugin" "$FINAL_PATH/wp-content/mu-plugins" result

    # 3. Save results
    filename="$RESULTS_DIR$(echo "$website" | sed 's|https\?://||' | sed 's|/|_|g').json"
    if [ ${#result[@]} -gt 0 ]; then
        json="{\"timestamp\":\"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\""
        for key in "${!result[@]}"; do json+=",\"$key\":${result[$key]}"; done
        json+="}"
        echo "$json" > "$filename"
        echo -e "   ${GREEN}[+]${RESET} Vulnerabilities detected and saved."
    else
        [ -f "$filename" ] && rm "$filename"
        echo -e "   ${GREEN}[-]${RESET} No vulnerabilities found."
    fi
}

# ======================================================================
# Main
# ======================================================================
source /usr/local/opencli/db.sh

if [[ "$1" == "-all" || "$1" == "--all" ]]; then

    MAX_PARALLEL=$(($(nproc) * 2))
    [ "$MAX_PARALLEL" -lt 10 ] && MAX_PARALLEL=10

    websites=$(opencli websites-all wordpress)
    readarray -t website_array <<<"$websites"
    TOTAL_SITES=${#website_array[@]}
    START_TIME=$(date +%s)

    for i in "${!website_array[@]}"; do
        ((job_count=job_count%MAX_PARALLEL)); ((job_count++==0)) && wait
        generate_report "${website_array[$i]}" "$((i+1))" "$TOTAL_SITES" &
    done
    wait

    END_TIME=$(date +%s)
    DUR=$((END_TIME - START_TIME))
    printf "\nSummary: %d Sites, %d Plugins, %d Themes in %02d:%02d:%02d\n" "$TOTAL_SITES" "$TOTAL_PLUGINS" "$TOTAL_THEMES" $((DUR/3600)) $(((DUR%3600)/60)) $((DUR%60))
elif [ $# -eq 1 ]; then
    generate_report "$1"
else
    usage
fi
